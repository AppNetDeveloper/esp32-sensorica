<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuracion Multi-Sensor IoT</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 16px;
            line-height: 1.5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            font-size: 1.5em;
            margin: 0 0 15px 0;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
            font-size: 1.2em;
            margin: 15px 0 10px 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%;
            padding: 12px 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 16px;
            font-weight: 600;
            min-height: 48px;
            touch-action: manipulation;
        }
        button:hover { background-color: #45a049; }
        button:active { transform: translateY(1px); }
        button.danger { background-color: #f44336; }
        button.danger:hover { background-color: #da190b; }
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        .status.success { background-color: #dff0d8; color: #3c763d; }
        .status.error { background-color: #f2dede; color: #a94442; }

        /* Pesta√±as m√≥viles optimizadas */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 8px;
            background-color: #e0e0e0;
            cursor: pointer;
            border: none;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .tab:first-child { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .tab:last-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Checkbox y radio optimizados para m√≥vil */
        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 12px 0;
        }
        .checkbox-group input {
            margin-right: 12px;
            min-width: 20px;
            min-height: 20px;
        }
        .checkbox-group span {
            font-size: 16px;
            user-select: none;
        }

        /* Media queries para diferentes tama√±os */
        @media (max-width: 600px) {
            body { padding: 5px; font-size: 16px; }
            .container { padding: 12px; border-radius: 8px; }
            h1 { font-size: 1.3em; }
            h2 { font-size: 1.1em; }
            .tabs { flex-direction: row; flex-wrap: wrap; }
            .tab { font-size: 11px; padding: 10px 6px; }
            button {
                width: calc(50% - 8px);
                margin: 4px 0;
                padding: 16px;
                font-size: 16px;
            }
            button.full-width { width: 100%; }
            input[type="text"], input[type="number"], input[type="password"], select {
                padding: 16px 12px;
                font-size: 16px; /* Previene zoom en iOS */
            }
        }

        @media (max-width: 400px) {
            .tab { font-size: 10px; padding: 8px 4px; }
            h1 { font-size: 1.2em; }
            .container { padding: 10px; }
        }

        /* Bot√≥n grande principal */
        .save-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        /* Mejora para inputs inv√°lidos */
        input:invalid, input.error {
            border-color: #f44336;
            background-color: #fff5f5;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Panel de Configuracion Multi-Sensor IoT</h1>

        <div class="tabs">
            <div class="tab active" onclick="showTab('network')">Red</div>
            <div class="tab" onclick="showTab('wifi')">üì∂ WiFi</div>
            <div class="tab" onclick="showTab('connection')">üîó Conexi√≥n</div>
            <div class="tab" onclick="showTab('mqtt')">MQTT</div>
            <div class="tab" onclick="showTab('device')">Dispositivo</div>
            <div class="tab" onclick="showTab('sensor')">üéõÔ∏è Sensor</div>
            <div class="tab" onclick="showTab('system')">Sistema</div>
        </div>

        <form action="/save" method="POST" onsubmit="return validateForm()">
            <!-- Network Tab -->
            <div id="network" class="tab-content active">
                <h2>Configuracion de Red</h2>
                <div class="form-group">
                    <label for="dhcpEnabled">
                        <input type="checkbox" id="dhcpEnabled" name="dhcpEnabled" checked onchange="toggleStaticIP()">
                        Usar DHCP
                    </label>
                </div>

                <div id="staticIPFields" style="display: none;">
                    <div class="form-group">
                        <label for="staticIP">IP Estatica:</label>
                        <input type="text" id="staticIP" name="staticIP" placeholder="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label for="gateway">Gateway:</label>
                        <input type="text" id="gateway" name="gateway" placeholder="192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label for="subnet">Mascara de Subred:</label>
                        <input type="text" id="subnet" name="subnet" placeholder="255.255.255.0">
                    </div>
                    <div class="form-group">
                        <label for="dns1">DNS Primario:</label>
                        <input type="text" id="dns1" name="dns1" placeholder="8.8.8.8">
                    </div>
                    <div class="form-group">
                        <label for="dns2">DNS Secundario:</label>
                        <input type="text" id="dns2" name="dns2" placeholder="8.8.4.4">
                    </div>
                </div>
            </div>

            <!-- WiFi Tab -->
            <div id="wifi" class="tab-content">
                <h2>Configuracion WiFi</h2>
                <div class="form-group">
                    <label for="wifiEnabled">Habilitar WiFi:</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="wifiEnabled" name="wifiEnabled">
                        <span>Activar conexion WiFi como backup</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="wifiSSID">SSID WiFi:</label>
                    <input type="text" id="wifiSSID" name="wifiSSID" placeholder="Nombre de la red WiFi">
                </div>
                <div class="form-group">
                    <label for="wifiPassword">Contrase√±a WiFi:</label>
                    <input type="password" id="wifiPassword" name="wifiPassword" placeholder="Contrase√±a de la red WiFi">
                </div>
            </div>

            <!-- Connection Tab -->
            <div id="connection" class="tab-content">
                <h2>Modo de Conexion</h2>
                <div class="form-group">
                    <label for="connectionMode">Modo de conexion principal:</label>
                    <select id="connectionMode" name="connectionMode">
                        <option value="0">Ethernet (prioritario)</option>
                        <option value="1">WiFi (unicamente)</option>
                        <option value="2">Dual: Ethernet + WiFi backup</option>
                    </select>
                    <p><small>
                        ‚Ä¢ <strong>Ethernet:</strong> Conexion cableada prioritaria<br>
                        ‚Ä¢ <strong>WiFi:</strong> Conexion inalambrica unicamente<br>
                        ‚Ä¢ <strong>Dual:</strong> Ethernet como primario, WiFi como respaldo
                    </small></p>
                </div>
            </div>

            <!-- MQTT Tab -->
            <div id="mqtt" class="tab-content">
                <h2>Configuracion MQTT</h2>
                <div class="form-group">
                    <label for="mqttServer">Servidor MQTT:</label>
                    <input type="text" id="mqttServer" name="mqttServer" required placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="mqttPort">Puerto MQTT:</label>
                    <input type="number" id="mqttPort" name="mqttPort" value="1883" min="1" max="65535" placeholder="1883">
                </div>
                <div class="form-group">
                    <label for="mqttUsername">Usuario MQTT:</label>
                    <input type="text" id="mqttUsername" name="mqttUsername" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label for="mqttPassword">Contrase&ntilde;a MQTT:</label>
                    <input type="password" id="mqttPassword" name="mqttPassword" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label for="mqttTopic">Topic MQTT:</label>
                    <input type="text" id="mqttTopic" name="mqttTopic" required placeholder="multi-sensor/iot">
                </div>
                <div class="form-group">
                    <label for="mqttClientId">Client ID MQTT:</label>
                    <input type="text" id="mqttClientId" name="mqttClientId" placeholder="Auto-generado">
                </div>
                <div class="form-group">
                    <label for="mqttKeepAlive">Keep Alive (segundos):</label>
                    <input type="number" id="mqttKeepAlive" name="mqttKeepAlive" value="60" min="10" max="300" placeholder="60">
                </div>
            </div>

            <!-- Device Tab -->
            <div id="device" class="tab-content">
                <h2>Configuracion del Dispositivo</h2>
                <div class="form-group">
                    <label for="deviceName">Nombre del Dispositivo:</label>
                    <input type="text" id="deviceName" name="deviceName" required placeholder="Multi-Sensor-IoT-01">
                </div>
                <div class="form-group">
                    <label for="location">Ubicacion:</label>
                    <input type="text" id="location" name="location" placeholder="Oficina Principal">
                </div>
                <div class="form-group">
                    <label for="sensorInterval">Intervalo de Medici√≥n (ms):</label>
                    <input type="number" id="sensorInterval" name="sensorInterval" value="50" min="10" max="5000" placeholder="50">
                </div>
                <div class="form-group">
                    <label for="readingsCount">Cantidad de Lecturas para Promedio:</label>
                    <input type="number" id="readingsCount" name="readingsCount" value="10" min="3" max="50" placeholder="10">
                </div>
                <div class="form-group">
                    <label for="debugMode">
                        <input type="checkbox" id="debugMode" name="debugMode">
                        Modo Debug
                    </label>
                </div>
            </div>

            <!-- Sensor Tab -->
            <div id="sensor" class="tab-content">
                <h2>üéõÔ∏è Configuraci√≥n de Sensores</h2>

                <div class="form-group">
                    <label for="sensorType">Tipo de Sensor:</label>
                    <select id="sensorType" name="sensorType" onchange="updateSensorFields()">
                        <option value="0">üìè Ultrasonido HC-SR04</option>
                        <option value="1">üîò 1 Pulsador</option>
                        <option value="2">üîòüîò 2 Pulsadores</option>
                        <option value="3">üì≥ Sensor Vibraci√≥n SW-420</option>
                    </select>
                </div>

                <!-- Configuraci√≥n para Ultrasonido -->
                <div id="ultrasonic-config" class="sensor-config">
                    <div class="form-group">
                        <label for="mainMqttTopic">Topic MQTT Principal:</label>
                        <input type="text" id="mainMqttTopic" name="mainMqttTopic" placeholder="multi-sensor/iot">
                    </div>
                    <div class="status success">
                        <strong>Configuraci√≥n Pines:</strong><br>
                        ‚Ä¢ Trigger: GPIO 25<br>
                        ‚Ä¢ Echo: GPIO 26
                    </div>
                </div>

                <!-- Configuraci√≥n para 1 Pulsador -->
                <div id="single-button-config" class="sensor-config" style="display:none;">
                    <div class="form-group">
                        <label for="button1Pin">Pin GPIO Pulsador 1:</label>
                        <select id="button1Pin" name="button1Pin">
                            <option value="13">GPIO 13</option>
                            <option value="14">GPIO 14</option>
                            <option value="25">GPIO 25</option>
                            <option value="26">GPIO 26</option>
                            <option value="32">GPIO 32</option>
                            <option value="33">GPIO 33</option>
                            <option value="34">GPIO 34</option>
                            <option value="35">GPIO 35</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="button1Invert">
                            <input type="checkbox" id="button1Invert" name="button1Invert">
                            Invertir Se√±al (1=abierto, 0=cerrado)
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="button1Topic">Topic MQTT Pulsador 1:</label>
                        <input type="text" id="button1Topic" name="button1Topic" placeholder="sensor/button1">
                    </div>
                </div>

                <!-- Configuraci√≥n para 2 Pulsadores -->
                <div id="dual-buttons-config" class="sensor-config" style="display:none;">
                    <h3>Pulsador 1:</h3>
                    <div class="form-group">
                        <label for="dualButton1Pin">Pin GPIO Pulsador 1:</label>
                        <select id="dualButton1Pin" name="dualButton1Pin">
                            <option value="13">GPIO 13</option>
                            <option value="14">GPIO 14</option>
                            <option value="25">GPIO 25</option>
                            <option value="26">GPIO 26</option>
                            <option value="32">GPIO 32</option>
                            <option value="33">GPIO 33</option>
                            <option value="34">GPIO 34</option>
                            <option value="35">GPIO 35</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dualButton1Invert">
                            <input type="checkbox" id="dualButton1Invert" name="dualButton1Invert">
                            Invertir Se√±al Pulsador 1
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="dualButton1Topic">Topic MQTT Pulsador 1:</label>
                        <input type="text" id="dualButton1Topic" name="dualButton1Topic" placeholder="sensor/button1">
                    </div>

                    <h3>Pulsador 2:</h3>
                    <div class="form-group">
                        <label for="button2Pin">Pin GPIO Pulsador 2:</label>
                        <select id="button2Pin" name="button2Pin">
                            <option value="13">GPIO 13</option>
                            <option value="14">GPIO 14</option>
                            <option value="25">GPIO 25</option>
                            <option value="26">GPIO 26</option>
                            <option value="32">GPIO 32</option>
                            <option value="33">GPIO 33</option>
                            <option value="34">GPIO 34</option>
                            <option value="35">GPIO 35</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="button2Invert">
                            <input type="checkbox" id="button2Invert" name="button2Invert">
                            Invertir Se√±al Pulsador 2
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="button2Topic">Topic MQTT Pulsador 2:</label>
                        <input type="text" id="button2Topic" name="button2Topic" placeholder="sensor/button2">
                    </div>
                </div>

                <!-- Configuraci√≥n para Sensor Vibraci√≥n -->
                <div id="vibration-config" class="sensor-config" style="display:none;">
                    <div class="form-group">
                        <label for="vibrationPin">Pin GPIO Sensor Vibraci√≥n:</label>
                        <select id="vibrationPin" name="vibrationPin">
                            <option value="32" selected>GPIO 32 (Recomendado)</option>
                            <option value="13">GPIO 13</option>
                            <option value="14">GPIO 14</option>
                            <option value="25">GPIO 25</option>
                            <option value="26">GPIO 26</option>
                            <option value="33">GPIO 33</option>
                            <option value="34">GPIO 34</option>
                            <option value="35">GPIO 35</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vibrationThreshold">Cooldown entre Detecciones (ms):</label>
                        <input type="number" id="vibrationThreshold" name="vibrationThreshold" value="100" min="50" max="5000" placeholder="100">
                        <small>Tiempo m√≠nimo entre detecciones para evitar spam</small>
                    </div>
                    <div class="form-group">
                        <label for="vibrationTopic">Topic MQTT Vibraci√≥n:</label>
                        <input type="text" id="vibrationTopic" name="vibrationTopic" placeholder="sensor/vibration">
                    </div>
                    <div class="status success">
                        <strong>Informaci√≥n Sensor SW-420:</strong><br>
                        ‚Ä¢ LOW = Vibraci√≥n detectada<br>
                        ‚Ä¢ HIGH = Sin vibraci√≥n<br>
                        ‚Ä¢ Sensibilidad ajustable v√≠a potenci√≥metro
                    </div>
                </div>
            </div>

            <!-- System Tab -->
            <div id="system" class="tab-content">
                <h2>Sistema</h2>
                <div class="status success">
                    <strong>Firmware Version:</strong> <span id="firmwareVersion">1.0.0</span><br>
                    <strong>MAC Address:</strong> <span id="macAddress">Calculando...</span><br>
                    <strong>Uptime:</strong> <span id="uptime">Calculando...</span>
                </div>

                <button type="button" onclick="window.location.href='/status'">Ver Estado</button>
                <button type="button" class="danger" onclick="if(confirm('¬øEstas seguro de que quieres resetear toda la configuracion?')) { window.location.href='/reset'; }">Resetear Configuracion</button>
                <button type="button" class="danger" onclick="if(confirm('¬øEstas seguro de que quieres salir del modo bridge?')) { window.location.href='/exit'; }">Salir Modo Bridge</button>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button type="submit" class="save-button full-width">üíæ Guardar Configuracion</button>
            </div>
        </form>
    </div>

    <script>
        // Tab functionality
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Update sensor configuration fields based on sensor type
        function updateSensorFields() {
            const sensorType = document.getElementById('sensorType').value;

            // Hide all sensor configurations
            document.getElementById('ultrasonic-config').style.display = 'none';
            document.getElementById('single-button-config').style.display = 'none';
            document.getElementById('dual-buttons-config').style.display = 'none';
            document.getElementById('vibration-config').style.display = 'none';

            // Show relevant configuration
            switch(sensorType) {
                case '0': // Ultrasonido
                    document.getElementById('ultrasonic-config').style.display = 'block';
                    break;
                case '1': // 1 Pulsador
                    document.getElementById('single-button-config').style.display = 'block';
                    break;
                case '2': // 2 Pulsadores
                    document.getElementById('dual-buttons-config').style.display = 'block';
                    break;
                case '3': // Sensor Vibraci√≥n
                    document.getElementById('vibration-config').style.display = 'block';
                    break;
            }
        }

        // Form validation
        function validateForm() {
            // Validar campos requeridos b√°sicos
            const requiredFields = ['mqttServer', 'deviceName'];
            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    alert('‚ùå Campo requerido faltante: ' + element.previousElementSibling.textContent);
                    element.focus();
                    element.style.borderColor = 'red';
                    return false;
                } else {
                    element.style.borderColor = '';
                }
            }

            // Validar MQTT Port
            const mqttPort = document.getElementById('mqttPort');
            if (mqttPort.value && (mqttPort.value < 1 || mqttPort.value > 65535)) {
                alert('‚ùå El puerto MQTT debe estar entre 1 y 65535');
                mqttPort.focus();
                mqttPort.style.borderColor = 'red';
                return false;
            } else {
                mqttPort.style.borderColor = '';
            }

            // Validar servidor MQTT (no localhost)
            const mqttServer = document.getElementById('mqttServer').value.trim();
            if (mqttServer === 'localhost' || mqttServer === '127.0.0.1') {
                alert('‚ùå El servidor MQTT no puede ser localhost o 127.0.0.1');
                document.getElementById('mqttServer').focus();
                document.getElementById('mqttServer').style.borderColor = 'red';
                return false;
            }

            // Validar configuraci√≥n de red si DHCP est√° desactivado
            const dhcpEnabled = document.getElementById('dhcpEnabled').checked;
            if (!dhcpEnabled) {
                const ipFields = ['staticIP', 'gateway', 'subnet'];
                for (let field of ipFields) {
                    const element = document.getElementById(field);
                    if (!element.value.trim()) {
                        alert('‚ùå Campo requerido para IP est√°tica: ' + element.previousElementSibling.textContent);
                        element.focus();
                        element.style.borderColor = 'red';
                        return false;
                    } else {
                        element.style.borderColor = '';
                    }
                }

                // Validar formato de IP
                const staticIP = document.getElementById('staticIP').value.trim();
                const gateway = document.getElementById('gateway').value.trim();
                const subnet = document.getElementById('subnet').value.trim();

                if (!validateIP(staticIP)) {
                    alert('‚ùå La IP est√°tica no tiene un formato v√°lido');
                    document.getElementById('staticIP').focus();
                    document.getElementById('staticIP').style.borderColor = 'red';
                    return false;
                }
                if (!validateIP(gateway)) {
                    alert('‚ùå El gateway no tiene un formato v√°lido');
                    document.getElementById('gateway').focus();
                    document.getElementById('gateway').style.borderColor = 'red';
                    return false;
                }
                if (!validateIP(subnet)) {
                    alert('‚ùå La m√°scara de subred no tiene un formato v√°lido');
                    document.getElementById('subnet').focus();
                    document.getElementById('subnet').style.borderColor = 'red';
                    return false;
                }
            }

            // Validar que no haya caracteres inv√°lidos en nombres
            const deviceName = document.getElementById('deviceName').value.trim();
            if (deviceName.length < 3) {
                alert('‚ùå El nombre del dispositivo debe tener al menos 3 caracteres');
                document.getElementById('deviceName').focus();
                document.getElementById('deviceName').style.borderColor = 'red';
                return false;
            }

            // Confirmar antes de guardar
            return confirm('‚úÖ ¬øEst√°s seguro de guardar esta configuraci√≥n? El dispositivo se reiniciar√° autom√°ticamente.');
        }

        // Funci√≥n para validar formato de IP
        function validateIP(ip) {
            const ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipRegex.test(ip);
        }

        // Toggle static IP fields
        function toggleStaticIP() {
            const dhcpEnabled = document.getElementById('dhcpEnabled').checked;
            const staticFields = document.getElementById('staticIPFields');
            staticFields.style.display = dhcpEnabled ? 'none' : 'block';
        }

        // Load device configuration from server
        async function loadDeviceConfig() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Load network configuration
                if (data.dhcpEnabled !== undefined) {
                    document.getElementById('dhcpEnabled').checked = data.dhcpEnabled;
                    toggleStaticIP();
                }
                if (data.staticIP) document.getElementById('staticIP').value = data.staticIP;
                if (data.gateway) document.getElementById('gateway').value = data.gateway;
                if (data.subnet) document.getElementById('subnet').value = data.subnet;
                if (data.dns1) document.getElementById('dns1').value = data.dns1;
                if (data.dns2) document.getElementById('dns2').value = data.dns2;

                // Load WiFi configuration
                if (data.wifiEnabled !== undefined) {
                    document.getElementById('wifiEnabled').checked = data.wifiEnabled;
                }
                if (data.wifiSSID) document.getElementById('wifiSSID').value = data.wifiSSID;
                if (data.wifiPassword) document.getElementById('wifiPassword').value = data.wifiPassword;

                // Load connection mode
                if (data.connectionMode !== undefined) {
                    document.getElementById('connectionMode').value = data.connectionMode;
                }

                // Load MQTT configuration
                if (data.mqttServer) document.getElementById('mqttServer').value = data.mqttServer;
                if (data.mqttPort) document.getElementById('mqttPort').value = data.mqttPort;
                if (data.mqttUsername) document.getElementById('mqttUsername').value = data.mqttUsername;
                if (data.mqttPassword) document.getElementById('mqttPassword').value = data.mqttPassword;
                if (data.mqttTopic) document.getElementById('mqttTopic').value = data.mqttTopic;
                if (data.mqttClientId) document.getElementById('mqttClientId').value = data.mqttClientId;
                if (data.mqttKeepAlive) document.getElementById('mqttKeepAlive').value = data.mqttKeepAlive;

                // Load sensor configuration
                if (data.sensorType !== undefined) {
                    document.getElementById('sensorType').value = data.sensorType;
                    updateSensorFields();
                }

                // Load sensor-specific settings
                if (data.button1Pin !== undefined) {
                    document.getElementById('button1Pin').value = data.button1Pin;
                    document.getElementById('dualButton1Pin').value = data.button1Pin;
                }
                if (data.button2Pin !== undefined) {
                    document.getElementById('button2Pin').value = data.button2Pin;
                }
                if (data.vibrationPin !== undefined) {
                    document.getElementById('vibrationPin').value = data.vibrationPin;
                }

                // Load MQTT topics (use mainMqttTopic for both, or mqttTopic as fallback)
                if (data.mainMqttTopic) {
                    document.getElementById('mainMqttTopic').value = data.mainMqttTopic;
                    // Also update the main MQTT topic if it's not set
                    if (!data.mqttTopic || data.mqttTopic === "sensor/distance") {
                        document.getElementById('mqttTopic').value = data.mainMqttTopic;
                    }
                }
                if (data.button1Topic) {
                    document.getElementById('button1Topic').value = data.button1Topic;
                    document.getElementById('dualButton1Topic').value = data.button1Topic;
                }
                if (data.button2Topic) {
                    document.getElementById('button2Topic').value = data.button2Topic;
                }
                if (data.vibrationTopic) {
                    document.getElementById('vibrationTopic').value = data.vibrationTopic;
                }

                // Load sensor settings
                if (data.vibrationThreshold !== undefined) {
                    document.getElementById('vibrationThreshold').value = data.vibrationThreshold;
                }

                // Load checkboxes
                if (data.button1Invert !== undefined) {
                    document.getElementById('button1Invert').checked = data.button1Invert;
                    document.getElementById('dualButton1Invert').checked = data.button1Invert;
                }
                if (data.button2Invert !== undefined) {
                    document.getElementById('button2Invert').checked = data.button2Invert;
                }

                // Load basic device settings
                if (data.deviceName) {
                    document.getElementById('deviceName').value = data.deviceName;
                }
                if (data.location) {
                    document.getElementById('location').value = data.location;
                }
                if (data.sensorInterval) {
                    document.getElementById('sensorInterval').value = data.sensorInterval;
                }
                if (data.readingsCount) {
                    document.getElementById('readingsCount').value = data.readingsCount;
                    // Also update the ultrasonic readings count
                    const ultrasonicReadingsCount = document.getElementById('ultrasonic-config').querySelector('#readingsCount');
                    if (ultrasonicReadingsCount) {
                        ultrasonicReadingsCount.value = data.readingsCount;
                    }
                }
                if (data.debugMode !== undefined) {
                    document.getElementById('debugMode').checked = data.debugMode;
                }

                // Load firmware version
                if (data.version) {
                    document.getElementById('firmwareVersion').textContent = data.version;
                }
                if (data.version) {
                    // Update all firmware version references
                    const versionElements = document.querySelectorAll('#firmwareVersion');
                    versionElements.forEach(el => el.textContent = data.version);
                }

            } catch (error) {
                console.log('Error loading device config:', error);
                // Initialize with ultrasonic as default
                updateSensorFields();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleStaticIP();
            loadDeviceConfig();

            // A√±adir validaci√≥n en tiempo real
            addRealtimeValidation();
        });

        // Funci√≥n para a√±adir validaci√≥n en tiempo real
        function addRealtimeValidation() {
            // Validar campos requeridos en tiempo real
            const requiredFields = ['mqttServer', 'deviceName'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.style.borderColor = '#28a745'; // Verde si tiene contenido
                    } else {
                        this.style.borderColor = '#dc3545'; // Rojo si est√° vac√≠o
                    }
                });

                field.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.style.borderColor = '#dc3545';
                    }
                });
            });

            // Validar puerto MQTT
            document.getElementById('mqttPort').addEventListener('input', function() {
                const port = parseInt(this.value);
                if (port >= 1 && port <= 65535) {
                    this.style.borderColor = '#28a745';
                } else {
                    this.style.borderColor = '#dc3545';
                }
            });

            // Validar campos de IP est√°tica
            const ipFields = ['staticIP', 'gateway', 'subnet'];
            ipFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function() {
                    if (validateIP(this.value.trim())) {
                        this.style.borderColor = '#28a745';
                    } else {
                        this.style.borderColor = '#dc3545';
                    }
                });
            });

            // Validar nombre del dispositivo
            document.getElementById('deviceName').addEventListener('input', function() {
                if (this.value.trim().length >= 3) {
                    this.style.borderColor = '#28a745';
                } else {
                    this.style.borderColor = '#dc3545';
                }
            });
        }
    </script>
</body>
</html>